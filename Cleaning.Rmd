```{r message=FALSE, warning=FALSE}
#Install and Load RCurl Package
library(curl)
library(tidyverse)

#Not reading from GitHub because it is crashing my R Studio
GAMES=read.csv("Data/games.csv")
GAMES_DETAILS=read.csv("Data/games_details.csv")
TEAMS=read.csv("Data/teams.csv")
```
```{r}
#Creating the Spread and Total variables
GAMES = mutate(GAMES, Spread=PTS_home-PTS_away, Total=PTS_home+PTS_away)
```
```{r message=FALSE}
#Obtain aggregated offensive rebound values
OREB = GAMES_DETAILS %>%
          select (TEAM_ABBREVIATION,GAME_ID,TEAM_ID,OREB) %>%
          transform(OREB = as.numeric(OREB)) %>%
          group_by(TEAM_ABBREVIATION,GAME_ID,TEAM_ID) %>%
          summarize(OREB=sum(OREB,na.rm=T)) %>%
          ungroup()
```
```{r message=FALSE}
#Obtain DREB
DREB = GAMES_DETAILS %>%
          select (TEAM_ABBREVIATION,GAME_ID,TEAM_ID,DREB) %>%
          transform(DREB = as.numeric(DREB)) %>%
          group_by(TEAM_ABBREVIATION,GAME_ID,TEAM_ID) %>%
          summarize(DREB=sum(DREB,na.rm=T)) %>%
          ungroup()
```
```{r message=FALSE}
#Obtain EFG%
EFGP = GAMES_DETAILS %>%
          select(TEAM_ABBREVIATION,GAME_ID,TEAM_ID,FGM,FGA,FG3M,FG3A) %>%
          group_by(TEAM_ABBREVIATION,GAME_ID,TEAM_ID) %>%
          summarize(EFGP=(sum(FGM, na.rm=T)+0.5*sum(FG3M, na.rm=T))/sum(FGA, na.rm=T)) %>%
          ungroup()
```
```{r message=FALSE}
#Obtain TOV%
TOVP = GAMES_DETAILS %>%
          select(TEAM_ABBREVIATION,GAME_ID,TEAM_ID,TO,FGA,FTA) %>%
          group_by(TEAM_ABBREVIATION,GAME_ID,TEAM_ID) %>%
          summarize(TOVP=sum(TO, na.rm=T)/(sum(FGA, na.rm=T)+0.44*sum(FTA, na.rm=T)+sum(TO, na.rm=T))) %>%
          ungroup()
```
```{r message=FALSE}
#Obtain FTR
FTR = GAMES_DETAILS %>%
          select(TEAM_ABBREVIATION,GAME_ID,TEAM_ID,FTA,FGA) %>%
          group_by(TEAM_ABBREVIATION,GAME_ID,TEAM_ID) %>%
          summarize(FTR=sum(FTA, na.rm=T)/sum(FGA, na.rm=T)) %>%
          ungroup()
```
```{r}
#Add OREB to GAMES
GAMES = left_join(GAMES, select(OREB, -TEAM_ABBREVIATION), by = c("GAME_ID", "HOME_TEAM_ID"="TEAM_ID")) %>%
          rename(OREB_home = OREB) %>%
          left_join(select(OREB, -TEAM_ABBREVIATION), by = c("GAME_ID", "VISITOR_TEAM_ID"="TEAM_ID")) %>%
          rename(OREB_away = OREB) %>%
          mutate(OREB = OREB_home + OREB_away)
```
```{r}
#Add DREB to GAMES
GAMES = left_join(GAMES, select(DREB, -TEAM_ABBREVIATION), by = c("GAME_ID", "HOME_TEAM_ID"="TEAM_ID")) %>%
          rename(DREB_home = DREB) %>%
          left_join(select(DREB, -TEAM_ABBREVIATION), by = c("GAME_ID", "VISITOR_TEAM_ID"="TEAM_ID")) %>%
          rename(DREB_away = DREB) %>%
          mutate(DREB = DREB_home + DREB_away)
```
```{r}
#Create OREB% and DREB% variables
GAMES = GAMES %>%
          mutate(OREBP_home=OREB_home/(OREB_home+DREB_away)) %>%
          mutate(OREBP_away=OREB_away/(OREB_away+DREB_home)) %>%
          mutate(DREBP_home=DREB_home/(DREB_home+OREB_away)) %>%
          mutate(DREBP_away=DREB_away/(DREB_away+OREB_home))
```
```{r}
#Add EFG% to GAMES
GAMES = left_join(GAMES, select(EFGP, -TEAM_ABBREVIATION), by = c("GAME_ID", "HOME_TEAM_ID"="TEAM_ID")) %>%
          rename(EFGP_home = EFGP) %>%
          left_join(select(EFGP, -TEAM_ABBREVIATION), by = c("GAME_ID", "VISITOR_TEAM_ID"="TEAM_ID")) %>%
          rename(EFGP_away = EFGP)
```
```{r}
#Add TOV% to GAMES
GAMES = left_join(GAMES, select(TOVP, -TEAM_ABBREVIATION), by = c("GAME_ID", "HOME_TEAM_ID"="TEAM_ID")) %>%
          rename(TOVP_home = TOVP) %>%
          left_join(select(TOVP, -TEAM_ABBREVIATION), by = c("GAME_ID", "VISITOR_TEAM_ID"="TEAM_ID")) %>%
          rename(TOVP_away = TOVP)
```
```{r}
#Add FTR to GAMES
GAMES = left_join(GAMES, select(FTR, -TEAM_ABBREVIATION), by = c("GAME_ID", "HOME_TEAM_ID"="TEAM_ID")) %>%
          rename(FTR_home = FTR) %>%
          left_join(select(FTR, -TEAM_ABBREVIATION), by = c("GAME_ID", "VISITOR_TEAM_ID"="TEAM_ID")) %>%
          rename(FTR_away = FTR)
```