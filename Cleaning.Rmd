```{r message=FALSE, warning=FALSE}
#Install and Load RCurl Package
library(curl)
library(tidyverse)

#Not reading from GitHub because it is crashing my R Studio
GAMES = read.csv("Data/games.csv")
GAMES_DETAILS = read.csv("Data/games_details.csv")
TEAMS = read.csv("Data/teams.csv")
PLAYERS = read.csv("Data/players.csv")
PREDICTIONS = read.csv("Data/Predictions.csv")
```
### CLEANING THE DATA

### TRAINING DATA
```{r}
TEAM_STATS = TEAMS[,c("TEAM_ID", "NICKNAME", "CITY")]
TEAM_STATS$TEAM_NAME = paste(TEAM_STATS$CITY, TEAM_STATS$NICKNAME)
TEAM_STATS = TEAM_STATS[,c("TEAM_ID", "TEAM_NAME")]
```
```{r}
#Clean the date variable in games
GAMES = GAMES %>%
          separate(GAME_DATE_EST, c("YEAR","MONTH","DAY"), sep='-', convert=TRUE, remove=TRUE)
```
```{r}
#Add the date variable to GAME_DETAILS
GAMES_DETAILS = left_join(GAMES_DETAILS, select(GAMES, c("GAME_ID", "YEAR", "MONTH", "DAY")), by="GAME_ID")
```
```{r}
#Clean the player data
PLAYERS = PLAYERS[,c(1,4,5,21)]
names(PLAYERS) = c("PLAYER_NAME","HEIGHT","WEIGHT","YEAR")
PLAYERS$WEIGHT = as.numeric(PLAYERS$WEIGHT)
PLAYERS = PLAYERS %>%
          separate(HEIGHT, c("FEET","INCHES"), sep='-', convert=TRUE, remove=TRUE) %>% 
          mutate(HEIGHT=12*FEET+INCHES) %>%
          select(-c(FEET, INCHES))
```
```{r}
#Add height and weight variables to GAME_DETAILS
GAMES_DETAILS = left_join(GAMES_DETAILS, PLAYERS, by=c("PLAYER_NAME", "YEAR"))
```
```{r}
#Creating the Spread and Total variables
GAMES = mutate(GAMES, Spread=PTS_home-PTS_away, Total=PTS_home+PTS_away)
```
```{r}
RECENT_GAMES = subset(GAMES, YEAR >= 2016)
RECENT_GAMES_DETAILS = subset(GAMES_DETAILS, YEAR >= 2016)
CURRENT_GAMES = subset(GAMES, YEAR >= 2020)
CURRENT_GAMES_DETAILS = subset(GAMES_DETAILS, YEAR >= 2020)
CURRENT_PLAYERS = subset(PLAYERS, YEAR >= 2020)
```
```{r}
POINTS = RECENT_GAMES_DETAILS %>%
        select(TEAM_ABBREVIATION, GAME_ID, TEAM_ID, PTS) %>%
        group_by(TEAM_ABBREVIATION, GAME_ID, TEAM_ID) %>%
        
```
```{r message=FALSE}
#Obtain OREB
OREB = RECENT_GAMES_DETAILS %>%
          select (TEAM_ABBREVIATION,GAME_ID,TEAM_ID,OREB) %>%
          transform(OREB = as.numeric(OREB)) %>%
          group_by(TEAM_ABBREVIATION,GAME_ID,TEAM_ID) %>%
          summarize(OREB=sum(OREB,na.rm=T)) %>%
          group_by(TEAM_ID) %>%
          summarize(OREB=mean(OREB,na.rm=T)) %>%
          ungroup()
TEAM_STATS = left_join(TEAM_STATS, OREB, by=c("TEAM_ID"))
```
```{r message=FALSE}
#Obtain DREB
DREB = RECENT_GAMES_DETAILS %>%
          select (TEAM_ABBREVIATION,GAME_ID,TEAM_ID,DREB) %>%
          transform(DREB = as.numeric(DREB)) %>%
          group_by(TEAM_ABBREVIATION,GAME_ID,TEAM_ID) %>%
          summarize(DREB=sum(DREB,na.rm=T)) %>%
          group_by(TEAM_ID) %>%
          summarize(DREB=mean(DREB,na.rm=T)) %>%
          ungroup()
TEAM_STATS = left_join(TEAM_STATS, DREB, by=c("TEAM_ID"))
```
```{r message=FALSE}
#Obtain EFG%
EFGP = RECENT_GAMES_DETAILS %>%
          select(TEAM_ABBREVIATION,GAME_ID,TEAM_ID,FGM,FGA,FG3M,FG3A) %>%
          group_by(TEAM_ABBREVIATION,GAME_ID,TEAM_ID) %>%
          summarize(EFGP=(sum(FGM, na.rm=T)+0.5*sum(FG3M, na.rm=T))/sum(FGA, na.rm=T)) %>%
          group_by(TEAM_ID) %>%
          summarize(EFGP=mean(EFGP,na.rm=T)) %>%
          ungroup()
TEAM_STATS = left_join(TEAM_STATS, EFGP, by=c("TEAM_ID"))
```
```{r message=FALSE}
#Obtain TOV%
TOVP = RECENT_GAMES_DETAILS %>%
          select(TEAM_ABBREVIATION,GAME_ID,TEAM_ID,TO,FGA,FTA) %>%
          group_by(TEAM_ABBREVIATION,GAME_ID,TEAM_ID) %>%
          summarize(TOVP=sum(TO, na.rm=T)/(sum(FGA, na.rm=T)+0.44*sum(FTA, na.rm=T)+sum(TO, na.rm=T))) %>%
          group_by(TEAM_ID) %>%
          summarize(TOVP=mean(TOVP,na.rm=T)) %>%
          ungroup()
TEAM_STATS = left_join(TEAM_STATS, TOVP, by=c("TEAM_ID"))
```
```{r message=FALSE}
#Obtain FTR
FTR = RECENT_GAMES_DETAILS %>%
          select(TEAM_ABBREVIATION,GAME_ID,TEAM_ID,FTA,FGA) %>%
          group_by(TEAM_ABBREVIATION,GAME_ID,TEAM_ID) %>%
          summarize(FTR=sum(FTA, na.rm=T)/sum(FGA, na.rm=T)) %>%
          group_by(TEAM_ID) %>%
          summarize(FTR=mean(FTR,na.rm=T)) %>%
          ungroup()
TEAM_STATS = left_join(TEAM_STATS, FTR, by=c("TEAM_ID"))
```
```{r}
#Calculate average height and weight of current players in the PLAYERS dataset
avg_height = mean(CURRENT_PLAYERS$HEIGHT,na.rm=T)
avg_weight = mean(CURRENT_PLAYERS$WEIGHT,na.rm=T)
```
```{r}
#Create identifier variables: ABOVE_AVG_HEIGHT & ABOVE_AVG_WEIGHT
CURRENT_GAMES_DETAILS$ABOVE_AVG_HEIGHT = ifelse(CURRENT_GAMES_DETAILS$HEIGHT > avg_height, 1, 0)
CURRENT_GAMES_DETAILS$ABOVE_AVG_WEIGHT = ifelse(CURRENT_GAMES_DETAILS$WEIGHT > avg_weight, 1, 0)
```
```{r message=FALSE}
#Obtain percentage above average height and percentage above average weight
HEIGHT_PROP = CURRENT_GAMES_DETAILS %>%
          select(TEAM_ABBREVIATION,GAME_ID,TEAM_ID,ABOVE_AVG_HEIGHT) %>%
          group_by(TEAM_ABBREVIATION,GAME_ID,TEAM_ID) %>%
          summarize(HEIGHT_PROP=sum(ABOVE_AVG_HEIGHT,na.rm=T)/n()) %>%
          group_by(TEAM_ID) %>%
          summarize(HEIGHT_PROP=mean(HEIGHT_PROP,na.rm=T))
WEIGHT_PROP = CURRENT_GAMES_DETAILS %>%
          select(TEAM_ABBREVIATION,GAME_ID,TEAM_ID,ABOVE_AVG_WEIGHT) %>%
          group_by(TEAM_ABBREVIATION,GAME_ID,TEAM_ID) %>%
          summarize(WEIGHT_PROP=sum(ABOVE_AVG_WEIGHT,na.rm=T)/n()) %>%
          group_by(TEAM_ID) %>%
          summarize(WEIGHT_PROP=mean(WEIGHT_PROP,na.rm=T))
TEAM_STATS = left_join(TEAM_STATS, HEIGHT_PROP, by=c("TEAM_ID"))
TEAM_STATS = left_join(TEAM_STATS, WEIGHT_PROP, by=c("TEAM_ID"))
```
```{r message=FALSE}
# Obtain AVG_HEIGHT and AVG_WEIGHT for current players
AVG_HEIGHT = CURRENT_GAMES_DETAILS %>%
          select(TEAM_ABBREVIATION,GAME_ID,TEAM_ID,HEIGHT) %>%
          group_by(TEAM_ABBREVIATION,GAME_ID,TEAM_ID) %>%
          summarize(AVG_HEIGHT = mean(HEIGHT, na.rm=T)) %>%
          group_by(TEAM_ID) %>%
          summarize(AVG_HEIGHT = mean(AVG_HEIGHT, na.rm=T))
AVG_WEIGHT = CURRENT_GAMES_DETAILS %>%
          select(TEAM_ABBREVIATION,GAME_ID,TEAM_ID,WEIGHT) %>%
          group_by(TEAM_ABBREVIATION,GAME_ID,TEAM_ID) %>%
          summarize(AVG_WEIGHT=mean(WEIGHT,na.rm=T)) %>%
          group_by(TEAM_ID) %>%
          summarize(AVG_WEIGHT=mean(AVG_WEIGHT,na.rm=T))
TEAM_STATS = left_join(TEAM_STATS, AVG_HEIGHT, by=c("TEAM_ID"))
TEAM_STATS = left_join(TEAM_STATS, AVG_WEIGHT, by=c("TEAM_ID"))
```

## OLD DATA
```{r}
OLD_TEAM_STATS = TEAMS[,c("TEAM_ID", "NICKNAME", "CITY")]
OLD_TEAM_STATS$TEAM_NAME = paste(OLD_TEAM_STATS$CITY, OLD_TEAM_STATS$NICKNAME)
OLD_TEAM_STATS = OLD_TEAM_STATS[,c("TEAM_ID", "TEAM_NAME")]
```
```{r}
OLD_GAMES = subset(GAMES, YEAR < 2016)
OLD_GAMES_DETAILS = subset(GAMES_DETAILS, YEAR < 2016)
OLD_PLAYERS = subset(PLAYERS, YEAR < 2016)
```
```{r message=FALSE}
#Obtain OREB
OLD_OREB = OLD_GAMES_DETAILS %>%
          select (TEAM_ABBREVIATION,GAME_ID,TEAM_ID,OREB) %>%
          transform(OREB = as.numeric(OREB)) %>%
          group_by(TEAM_ABBREVIATION,GAME_ID,TEAM_ID) %>%
          summarize(OREB=sum(OREB,na.rm=T)) %>%
          group_by(TEAM_ID) %>%
          summarize(OREB=mean(OREB,na.rm=T)) %>%
          ungroup()
OLD_TEAM_STATS = left_join(OLD_TEAM_STATS, OLD_OREB, by=c("TEAM_ID"))
```
```{r message=FALSE}
#Obtain DREB
OLD_DREB = OLD_GAMES_DETAILS %>%
          select (TEAM_ABBREVIATION,GAME_ID,TEAM_ID,DREB) %>%
          transform(DREB = as.numeric(DREB)) %>%
          group_by(TEAM_ABBREVIATION,GAME_ID,TEAM_ID) %>%
          summarize(DREB=sum(DREB,na.rm=T)) %>%
          group_by(TEAM_ID) %>%
          summarize(DREB=mean(DREB,na.rm=T)) %>%
          ungroup()
OLD_TEAM_STATS = left_join(OLD_TEAM_STATS, OLD_DREB, by=c("TEAM_ID"))
```
```{r message=FALSE}
#Obtain EFG%
OLD_EFGP = OLD_GAMES_DETAILS %>%
          select(TEAM_ABBREVIATION,GAME_ID,TEAM_ID,FGM,FGA,FG3M,FG3A) %>%
          group_by(TEAM_ABBREVIATION,GAME_ID,TEAM_ID) %>%
          summarize(EFGP=(sum(FGM, na.rm=T)+0.5*sum(FG3M, na.rm=T))/sum(FGA, na.rm=T)) %>%
          group_by(TEAM_ID) %>%
          summarize(EFGP=mean(EFGP,na.rm=T)) %>%
          ungroup()
OLD_TEAM_STATS = left_join(OLD_TEAM_STATS, OLD_EFGP, by=c("TEAM_ID"))
```
```{r message=FALSE}
#Obtain TOV%
OLD_TOVP = OLD_GAMES_DETAILS %>%
          select(TEAM_ABBREVIATION,GAME_ID,TEAM_ID,TO,FGA,FTA) %>%
          group_by(TEAM_ABBREVIATION,GAME_ID,TEAM_ID) %>%
          summarize(TOVP=sum(TO, na.rm=T)/(sum(FGA, na.rm=T)+0.44*sum(FTA, na.rm=T)+sum(TO, na.rm=T))) %>%
          group_by(TEAM_ID) %>%
          summarize(TOVP=mean(TOVP,na.rm=T)) %>%
          ungroup()
OLD_TEAM_STATS = left_join(OLD_TEAM_STATS, OLD_TOVP, by=c("TEAM_ID"))
```
```{r message=FALSE}
#Obtain FTR
OLD_FTR = OLD_GAMES_DETAILS %>%
          select(TEAM_ABBREVIATION,GAME_ID,TEAM_ID,FTA,FGA) %>%
          group_by(TEAM_ABBREVIATION,GAME_ID,TEAM_ID) %>%
          summarize(FTR=sum(FTA, na.rm=T)/sum(FGA, na.rm=T)) %>%
          group_by(TEAM_ID) %>%
          summarize(FTR=mean(FTR,na.rm=T)) %>%
          ungroup()
OLD_TEAM_STATS = left_join(OLD_TEAM_STATS, OLD_FTR, by=c("TEAM_ID"))
```
```{r}
#Calculate average height and weight of current players in the PLAYERS dataset
OLD_avg_height = mean(OLD_PLAYERS$HEIGHT,na.rm=T)
OLD_avg_weight = mean(OLD_PLAYERS$WEIGHT,na.rm=T)
```
```{r}
#Create identifier variables: ABOVE_AVG_HEIGHT & ABOVE_AVG_WEIGHT
OLD_GAMES_DETAILS$ABOVE_AVG_HEIGHT = ifelse(OLD_GAMES_DETAILS$HEIGHT > OLD_avg_height, 1, 0)
OLD_GAMES_DETAILS$ABOVE_AVG_WEIGHT = ifelse(OLD_GAMES_DETAILS$WEIGHT > OLD_avg_weight, 1, 0)
```
```{r message=FALSE}
#Obtain percentage above average height and percentage above average weight
OLD_HEIGHT_PROP = OLD_GAMES_DETAILS %>%
          select(TEAM_ABBREVIATION,GAME_ID,TEAM_ID,ABOVE_AVG_HEIGHT) %>%
          group_by(TEAM_ABBREVIATION,GAME_ID,TEAM_ID) %>%
          summarize(HEIGHT_PROP=sum(ABOVE_AVG_HEIGHT,na.rm=T)/n()) %>%
          group_by(TEAM_ID) %>%
          summarize(HEIGHT_PROP=mean(HEIGHT_PROP,na.rm=T))
OLD_WEIGHT_PROP = OLD_GAMES_DETAILS %>%
          select(TEAM_ABBREVIATION,GAME_ID,TEAM_ID,ABOVE_AVG_WEIGHT) %>%
          group_by(TEAM_ABBREVIATION,GAME_ID,TEAM_ID) %>%
          summarize(WEIGHT_PROP=sum(ABOVE_AVG_WEIGHT,na.rm=T)/n()) %>%
          group_by(TEAM_ID) %>%
          summarize(WEIGHT_PROP=mean(WEIGHT_PROP,na.rm=T))
OLD_TEAM_STATS = left_join(OLD_TEAM_STATS, OLD_HEIGHT_PROP, by=c("TEAM_ID"))
OLD_TEAM_STATS = left_join(OLD_TEAM_STATS, OLD_WEIGHT_PROP, by=c("TEAM_ID"))
```
```{r message=FALSE}
# Obtain AVG_HEIGHT and AVG_WEIGHT for current players
OLD_AVG_HEIGHT = OLD_GAMES_DETAILS %>%
          select(TEAM_ABBREVIATION,GAME_ID,TEAM_ID,HEIGHT) %>%
          group_by(TEAM_ABBREVIATION,GAME_ID,TEAM_ID) %>%
          summarize(AVG_HEIGHT = mean(HEIGHT, na.rm=T)) %>%
          group_by(TEAM_ID) %>%
          summarize(AVG_HEIGHT = mean(AVG_HEIGHT, na.rm=T))
OLD_AVG_WEIGHT = OLD_GAMES_DETAILS %>%
          select(TEAM_ABBREVIATION,GAME_ID,TEAM_ID,WEIGHT) %>%
          group_by(TEAM_ABBREVIATION,GAME_ID,TEAM_ID) %>%
          summarize(AVG_WEIGHT=mean(WEIGHT,na.rm=T)) %>%
          group_by(TEAM_ID) %>%
          summarize(AVG_WEIGHT=mean(AVG_WEIGHT,na.rm=T))
OLD_TEAM_STATS = left_join(OLD_TEAM_STATS, OLD_AVG_HEIGHT, by=c("TEAM_ID"))
OLD_TEAM_STATS = left_join(OLD_TEAM_STATS, OLD_AVG_WEIGHT, by=c("TEAM_ID"))
```